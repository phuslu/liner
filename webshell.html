<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title></title>
    <meta name="description" content="Liner WebShell" />
    <link rel="stylesheet" href="xterm.css" />
    <style>
        body {
            margin: 0;
            height: 100vh;
            background: #000;
            font-family: "ubuntu", "Tahoma", "Microsoft YaHei", Arial, Serif;
        }
        .webshell {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .webshell-terminal {
            flex: 1;
        }
        #terminal {
            width: 100%;
            height: 100%;
        }
        #reconnect-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            align-items: center;
            justify-content: center;
        }
        #reconnect-box {
            background: #d0d0d0;
            color: #000;
            padding: 14px 26px;
            border-radius: 12px;
            font-size: 22px;
            font-family: Menlo, Monaco, "Courier New", monospace;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.45);
        }
    </style>
</head>
<body>
    <div class="webshell">
        <div id="terminal" class="webshell-terminal"></div>
        <div id="reconnect-overlay"><div id="reconnect-box">Press ‚èé to Reconnect</div></div>
    </div>

    <script src="xterm.js"></script>
    <script src="xterm-addon-fit.js"></script>
    <script>
        document.title = "{{ get . `title` }}" || "webshell"
        const term = new Terminal({
            cursorBlink: true,
            disableStdin: false,
            fontSize: parseInt("{{ get . `font_size` }}") || 14,
            fontFamily: 'Menlo, Monaco, "Courier New", monospace',
            theme: { background: '#101010' },
            windowsMode: "{{ get . `windows_mode` }}" == "true",
        });
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal'));
        fitAddon.fit();

        const overlay = document.getElementById('reconnect-overlay');
        let reconnectMode = false;

        function showReconnectOverlay() {
            reconnectMode = true;
            overlay.style.display = 'flex';
            term.blur();
            term.write('\r\n\x1b[31mSession Ended\x1b[0m\r\nPress Enter to reconnect...\r\n');
        }

        function hideReconnectOverlay() {
            reconnectMode = false;
            overlay.style.display = 'none';
            term.focus();
        }

        const ws = new WebSocket(
            location.protocol.replace('http', 'ws') + '//' +
            location.host +
            location.pathname.replace(/\/[^/]*$/, '') + '/ws'
        );
        ws.binaryType = 'arraybuffer';

        ws.onopen = () => {
            hideReconnectOverlay();
            sendResize();
        };

        ws.onclose = () => {
            showReconnectOverlay();
        };

        ws.onmessage = (event) => {
            if (event.data instanceof ArrayBuffer) {
                term.write(new Uint8Array(event.data));
            } else {
                term.write(event.data);
            }
        };

        const encoder = new TextEncoder();
        term.onData((data) => {
            if (reconnectMode) return;
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(encoder.encode(data));
            }
        });

        function sendResize() {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'resize',
                    cols: term.cols,
                    rows: term.rows
                }));
            }
        }

        window.addEventListener('resize', () => {
            fitAddon.fit();
            sendResize();
        });

        window.addEventListener('keydown', (e) => {
            if (reconnectMode && e.key === 'Enter') {
                location.reload();
            }
        });
    </script>
</body>
</html>
